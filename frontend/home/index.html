<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa Interativo</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        /* Fullscreen map */
        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Search bar at the top-left */
        .search-bar {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 250px;
            z-index: 1000;
            background-color: white;
            border-radius: 50px;
            padding: 10px 20px;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
        }

        /* Locate button at the bottom-right */
        .locate-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background-color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        .locate-button svg {
            fill: blue;
        }

        .locate-button:focus {
            outline: none;
        }

        .locate-button:hover {
            background-color: #f0f0f0;
        }

        /* Bottom drawer - hidden when inactive */
        .drawer {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0px -4px 10px rgba(0, 0, 0, 0.1);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            max-height: 40vh;
            overflow-y: auto;
            z-index: 999;
            transform: translateY(95%);
            /* Almost hidden by default */
            transition: transform 0.3s ease;
        }

        /* Exibir a gaveta */
        .drawer-open {
            transform: translateY(0);
            /* Fully visible when open */
        }

        /* Drawer toggle handle */
        .drawer-toggle {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 5px;
            background-color: gray;
            border-radius: 50px;
            cursor: pointer;
        }

        /* Panel styles */
        .panel {
            display: none;
        }

        .panel-active {
            display: block;
        }

        /* Star rating styles */
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 2em;
            color: gray;
            cursor: pointer;
        }

        .star-rating input:checked~label,
        .star-rating label:hover,
        .star-rating label:hover~label {
            color: gold;
        }

        .star-display {
            color: gold;
            font-size: 1.5em;
        }
    </style>
</head>

<body>
    <!-- Search Bar -->
    <div class="search-bar shadow">
        <input type="text" class="form-control" placeholder="Pesquisar local..." id="search-input">
    </div>

    <!-- Mapa -->
    <div id="map"></div>

    <!-- Bottom Drawer -->
    <div id="infoDrawer" class="drawer p-3">
        <div class="drawer-toggle"></div>
        <ul class="nav nav-tabs" id="drawerTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="geral-tab" data-bs-toggle="tab" data-bs-target="#geral" type="button" role="tab" aria-controls="geral" aria-selected="true">Geral</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reviews-tab" data-bs-toggle="tab" data-bs-target="#reviews" type="button" role="tab" aria-controls="reviews" aria-selected="false">Reviews</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="cardapio-tab" data-bs-toggle="tab" data-bs-target="#cardapio" type="button" role="tab" aria-controls="cardapio" aria-selected="false">Cardápio</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="avisos-tab" data-bs-toggle="tab" data-bs-target="#avisos" type="button" role="tab" aria-controls="avisos" aria-selected="false">Avisos</button>
            </li>
        </ul>
        <div class="tab-content" id="drawerContent">
            <div class="tab-pane fade show active panel" id="geral" role="tabpanel" aria-labelledby="geral-tab">
                <h5 id="drawer-title"></h5>
                <p id="drawer-description"></p>
                <p id="drawer-subtitle"></p>
                <p id="drawer-status"></p>
                <div id="drawer-stars" class="star-display"></div>
            </div>
            <div class="tab-pane fade panel" id="reviews" role="tabpanel" aria-labelledby="reviews-tab">
                <div id="reviews-list"></div>
                <div>
                    <h6>Deixe sua review:</h6>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5" /><label for="star5">★</label>
                        <input type="radio" id="star4" name="rating" value="4" /><label for="star4">★</label>
                        <input type="radio" id="star3" name="rating" value="3" /><label for="star3">★</label>
                        <input type="radio" id="star2" name="rating" value="2" /><label for="star2">★</label>
                        <input type="radio" id="star1" name="rating" value="1" /><label for="star1">★</label>
                    </div>
                    <textarea id="review-texto" placeholder="Sua review" class="form-control mb-2"></textarea>
                    <button id="submit-review" class="btn btn-primary">Enviar</button>
                </div>
            </div>
            <div class="tab-pane fade panel" id="cardapio" role="tabpanel" aria-labelledby="cardapio-tab">
                <div id="cardapio-content"></div>
            </div>
            <div class="tab-pane fade panel" id="avisos" role="tabpanel" aria-labelledby="avisos-tab">
                <div id="avisos-content"></div>
            </div>
        </div>
        <input type="hidden" id="current-place-id">
    </div>

    <!-- Locate Button -->
    <button id="locate-btn" class="locate-button">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="blue" class="bi bi-geo-alt" viewBox="0 0 16 16">
            <path d="M12.166 8.94c-.44 1.47-1.278 2.91-2.395 4.196-1.214 1.386-2.571 2.517-3.47 3.05-.212.123-.432.181-.658.181-.3 0-.63-.16-.926-.465C4.053 15.139 1.1 12.467.166 11.025c-.545-.851-.742-1.61-.61-2.278.158-.817.743-1.517 1.58-1.982a5.513 5.513 0 0 1 2.168-.63 5.52 5.52 0 0 1 2.267.417l.707-.707a4.5 4.5 0 1 1 4.528-2.145.752.752 0 0 1 .907-.098 4.477 4.477 0 0 1 2.145 4.528l-.707.707a5.515 5.515 0 0 1 .417 2.267c-.464.837-1.165 1.423-1.982 1.58-.668.132-1.427-.065-2.278-.61C12.467 11.1 9.795 8.147 8.94 7.834c-.305-.296-.465-.626-.465-.926 0-.226.058-.446.181-.658.533-.9 1.664-2.256 3.05-3.47C13.09 2.544 14.53 1.705 16 1.265v7.235c-1.47-.44-2.91-1.278-4.196-2.395-1.386-1.214-2.517-2.571-3.05-3.47-.123-.212-.181-.432-.181-.658 0-.3.16-.63.465-.926z"/>
        </svg>
    </button>

    <!-- Bootstrap JS & Leaflet JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

    <script>
        var map = L.map('map', {
            zoomControl: false
        }).setView([-23.5505, -46.6333], 12); // São Paulo

        L.tileLayer('https://api.maptiler.com/maps/basic-v2/256/{z}/{x}/{y}.png?key=fnkpFFmNdDVOlFHshRfl').addTo(map);

        // Add a pin function
        function addPin(lat, lon, localId) {
            L.marker([lat, lon]).addTo(map).on('click', function () {
                fetch(`/api/getpininfo/${localId}`)
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById('current-place-id').value = localId;
                        document.getElementById('drawer-title').textContent = data.nome;
                        document.getElementById('drawer-description').textContent = data.descricao;
                        document.getElementById('drawer-subtitle').textContent = data.subtitulo;
                        document.getElementById('drawer-status').textContent = data.status;
                        document.getElementById('drawer-stars').innerHTML = getStarIcons(data.estrelas);
                        document.getElementById('infoDrawer').classList.add('drawer-open');

                        // Fetch and display reviews
                        fetchReviews(localId);

                        // Fetch and display cardapio
                        fetch(`/api/getcardapio/${localId}`)
                            .then(response => response.json())
                            .then(cardapio => {
                                const cardapioContent = document.getElementById('cardapio-content');
                                cardapioContent.innerHTML = '';
                                cardapio.forEach(item => {
                                    const cardapioItem = document.createElement('div');
                                    cardapioItem.innerHTML = `<strong>${item.nome}</strong>: ${item.descricao}`;
                                    cardapioContent.appendChild(cardapioItem);
                                });
                            });

                        // Fetch and display avisos
                        fetch(`/api/getavisos/${localId}`)
                            .then(response => response.json())
                            .then(avisos => {
                                const avisosContent = document.getElementById('avisos-content');
                                avisosContent.innerHTML = '';
                                avisos.forEach(aviso => {
                                    const avisoItem = document.createElement('div');
                                    avisoItem.innerHTML = `<strong>${aviso.titulo}</strong>: ${aviso.descricao}`;
                                    avisosContent.appendChild(avisoItem);
                                });
                            });

                        // Clear review fields
                        clearReviewFields();
                    });
            });
        }

        // Add all pins
        function addAllPins() {
            fetch('/api/getallpins')
                .then(response => response.json())
                .then(data => {
                    data.forEach(pin => {
                        addPin(pin.lat, pin.lon, pin.id);
                    });
                });
        }

        // Add a marker to user's current location
        function locateUser() {
            map.locate({ setView: true, maxZoom: 16 });
            map.on('locationfound', function (e) {
                L.marker(e.latlng).addTo(map).bindPopup("Você está aqui").openPopup();
            });
            map.on('locationerror', function () {
                alert("Não foi possível encontrar sua localização.");
            });
        }

        document.getElementById('locate-btn').addEventListener('click', function () {
            locateUser();
        });

        // Toggle drawer when clicking the toggle handle
        document.querySelector('.drawer-toggle').addEventListener('click', function () {
            document.getElementById('infoDrawer').classList.toggle('drawer-open');
        });

        // Close drawer when clicking on the map
        map.on('click', function () {
            document.getElementById('infoDrawer').classList.remove('drawer-open');
        });

        // Submit a new review
        document.getElementById('submit-review').addEventListener('click', function () {
            const estrelas = document.querySelector('input[name="rating"]:checked').value;
            const texto = document.getElementById('review-texto').value;
            const localId = document.getElementById('current-place-id').value;

            fetch(`/api/postreview`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    place_id: localId,
                    estrelas: estrelas,
                    texto_review: texto
                })
            }).then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Review submitted successfully');
                        // Refresh reviews
                        fetchReviews(localId);
                        // Clear review fields
                        clearReviewFields();
                    } else {
                        alert('Failed to submit review');
                    }
                });
        });

        // Function to fetch and display reviews
        function fetchReviews(localId) {
            fetch(`/api/getreviews/${localId}`)
                .then(response => response.json())
                .then(reviews => {
                    const reviewsList = document.getElementById('reviews-list');
                    reviewsList.innerHTML = '';
                    reviews.forEach(review => {
                        const reviewItem = document.createElement('div');
                        reviewItem.innerHTML = `<strong>${review.usuario}</strong> (${review.estrelas} estrelas): ${review.texto_review}`;
                        reviewsList.appendChild(reviewItem);
                    });
                });
        }

        // Function to clear review fields
        function clearReviewFields() {
            document.querySelector('input[name="rating"]:checked').checked = false;
            document.getElementById('review-texto').value = '';
        }

        // Function to generate star icons based on rating
        function getStarIcons(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                stars += `<span class="bi bi-star${i <= rating ? '-fill' : ''}"></span>`;
            }
            return stars;
        }

        addAllPins();
    </script>
</body>

</html>